<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>API Keys | unfiltereduk.co.uk</title>
  <style>
    :root {
      --bg: #121212;
      --card-bg: #1e1e1e;
      --text: #e0e0e0;
      --text-secondary: #aaaaaa;
      --accent: #bb86fc;
      --error: #cf3339;
      --border: #333333;
      --hover-bg: #2a2a2a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }

    body { background: var(--bg); color: var(--text); }

    .topbar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 20px; background: #1f1f1f; border-bottom: 1px solid var(--border);
    }

    .logo { font-size: 22px; font-weight: bold; color: var(--accent); }
    .logo span { color: var(--error); }
    .topbar nav a { margin-left: 18px; color: var(--accent); text-decoration: none; font-size: 14px; }
    .topbar nav a:hover { text-decoration: underline; }

    .container {
      max-width: 900px; margin: 40px auto; padding: 20px; background: var(--card-bg);
      border-radius: 12px; border: 1px solid var(--border);
    }

    h2 { color: var(--text); margin-bottom: 20px; }

    input, button { padding: 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; }
    input { width: 100%; background: #2a2a2a; color: var(--text); margin-bottom: 16px; }
    button {
      background: var(--accent); color: white; border: none; cursor: pointer; font-weight: 500;
    }
    button:hover { background: #9b68db; }

    .key-list { margin-top: 30px; }
    .key-item {
      background: #222; padding: 16px; border-radius: 8px; margin-bottom: 10px; font-size: 14px;
    }
    .key-item strong { color: var(--accent); }
    .revoke { background: var(--error); margin-left: 10px; }
    .revoke:hover { background: #b00; }

    .status { padding: 12px; margin: 15px 0; border-radius: 6px; text-align: center; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #3a1818; color: var(--error); }
    .hidden { display: none; }
  </style>
</head>
<body>

  <!-- Topbar -->
  <div class="topbar">
    <div class="logo">unfiltered<span>uk</span>.co.uk</div>
    <nav>
      <a href="inbox.html">Inbox</a>
      <a href="profile.html">Profile</a>
      <a href="settings.html">Settings</a>
      <a href="#" onclick="logout()">Logout</a>
    </nav>
  </div>

  <!-- Main -->
  <div class="container">
    <h2>API Key Management</h2>
    <p>Create and manage API keys for trusted partners.</p>

    <input type="text" id="partnerName" placeholder="Partner Name (e.g., News Corp)" />
    <input type="number" id="expiresDays" placeholder="Auto-expire in days (optional)" min="1" />

    <button onclick="generateKey()">Generate API Key</button>

    <div id="status" class="status hidden"></div>

    <div class="key-list" id="keys"></div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    const userEmail = localStorage.getItem('email');
    if (!token) location.href = 'login.html';

    // Only show this page if user is solace@
    if (userEmail !== 'solace@unfiltereduk.co.uk') {
      alert('Access denied.');
      location.href = 'inbox.html';
    }

    async function generateKey() {
      const partnerName = document.getElementById('partnerName').value;
      const expiresDays = document.getElementById('expiresDays').value || null;

      const res = await fetch('/api/admin/generate-key', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ partnerName, expiresDays })
      });

      const data = await res.json();
      if (res.ok) {
        setStatus(`✅ Key generated: ${data.key}`, false);
        document.getElementById('partnerName').value = '';
        document.getElementById('expiresDays').value = '';
        loadKeys();
      } else {
        setStatus('❌ ' + data.error, true);
      }
    }

    async function loadKeys() {
      const res = await fetch('/api/admin/keys', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) return setStatus('Failed to load keys.', true);

      const keys = await res.json();
      const container = document.getElementById('keys');
      container.innerHTML = '';

      keys.forEach(k => {
        const div = document.createElement('div');
        div.className = 'key-item';
        div.innerHTML = `
          <div><strong>Key:</strong> ${k.key.substring(0, 20)}...</div>
          <div><strong>Partner:</strong> ${k.partnerName}</div>
          <div><strong>Created:</strong> ${new Date(k.createdAt).toLocaleString()}</div>
          <div><strong>Expires:</strong> ${k.expiresAt ? new Date(k.expiresAt).toLocaleString() : 'Never'}</div>
          <button class="revoke" onclick="revokeKey('${k.key}')">Revoke</button>
        `;
        container.appendChild(div);
      });
    }

    async function revokeKey(key) {
      if (!confirm('Revoke this API key?')) return;

      const res = await fetch('/api/admin/revoke-key', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ key })
      });

      if (res.ok) {
        setStatus('Key revoked.', false);
        loadKeys();
      } else {
        setStatus('Revoke failed.', true);
      }
    }

    function setStatus(msg, error = true) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = error ? 'status error' : 'status success';
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 5000);
    }

    function logout() {
      localStorage.clear();
      location.href = 'index.html';
    }

    window.onload = loadKeys;
  </script>
</body>
</html>
