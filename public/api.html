<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>API Keys | unfiltereduk.co.uk</title>
  <style>
    :root {
      --bg: #121212;
      --card-bg: #1e1e1e;
      --text: #e0e0e0;
      --text-secondary: #aaaaaa;
      --accent: #bb86fc;
      --error: #cf3339;
      --border: #333333;
      --hover-bg: #2a2a2a;
      --code-bg: #1e2b33;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }

    body { background: var(--bg); color: var(--text); }

    .topbar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 20px; background: #1f1f1f; border-bottom: 1px solid var(--border);
    }

    .logo { font-size: 22px; font-weight: bold; color: var(--accent); }
    .logo span { color: var(--error); }
    .topbar nav a { margin-left: 18px; color: var(--accent); text-decoration: none; font-size: 14px; }
    .topbar nav a:hover { text-decoration: underline; }

    .container {
      max-width: 900px; margin: 40px auto; padding: 20px; background: var(--card-bg);
      border-radius: 12px; border: 1px solid var(--border);
    }

    h2 { color: var(--text); margin-bottom: 20px; }

    input, button { padding: 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; }
    input { width: 100%; background: #2a2a2a; color: var(--text); margin-bottom: 16px; }
    button {
      background: var(--accent); color: white; border: none; cursor: pointer; font-weight: 500;
    }
    button:hover { background: #9b68db; }

    .key-display {
      background: var(--code-bg);
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #a0d8ff;
      margin: 10px 0;
      word-break: break-all;
      position: relative;
    }

    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #444;
      color: white;
      border: none;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    .copy-btn:hover { background: #666; }

    .key-list { margin-top: 30px; }
    .key-item {
      background: #222; padding: 16px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; position: relative;
    }
    .key-item strong { color: var(--accent); }
    .revoke { background: var(--error); margin-left: 10px; }
    .revoke:hover { background: #b00; }

    .status { padding: 12px; margin: 15px 0; border-radius: 6px; text-align: center; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #3a1818; color: var(--error); }
    .hidden { display: none; }
  </style>
</head>
<body>

  <!-- Topbar -->
  <div class="topbar">
    <div class="logo">unfiltered<span>uk</span>.co.uk</div>
    <nav>
      <a href="inbox.html">Inbox</a>
      <a href="profile.html">Profile</a>
      <a href="settings.html">Settings</a>
      <a href="#" onclick="logout()">Logout</a>
    </nav>
  </div>

  <!-- Main -->
  <div class="container">
    <h2>API Key Management</h2>
    <p>Create keys for partners. Optionally set a custom sender and avatar.</p>

    <input type="text" id="partnerName" placeholder="Partner Name (e.g., NewsCorp)" />
    <input type="email" id="customFrom" placeholder="Custom From Email (optional)" />
    <input type="url" id="avatar" placeholder="Avatar URL (optional, .jpg, .png)" />
    <input type="number" id="expiresDays" placeholder="Auto-expire in days (optional)" min="1" />

    <button onclick="generateKey()">Generate API Key</button>

    <div id="status" class="status hidden"></div>

    <!-- Show generated key -->
    <div id="keyOutput" class="hidden">
      <p><strong>Generated API Key:</strong></p>
      <div class="key-display" id="apiKeyDisplay">
        ukapi_...
        <button class="copy-btn" onclick="copyKey()">Copy</button>
      </div>
      <p><small>⚠️ This key will not be shown again. Save it now.</small></p>
    </div>

    <div class="key-list" id="keys"></div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    const userEmail = localStorage.getItem('email');
    if (!token) location.href = 'login.html';
    if (userEmail !== 'solace@unfiltereduk.co.uk') {
      alert('Access denied.');
      location.href = 'inbox.html';
    }

    async function generateKey() {
      const partnerName = document.getElementById('partnerName').value;
      const customFrom = document.getElementById('customFrom').value || null;
      const avatar = document.getElementById('avatar').value || null;
      const expiresDays = document.getElementById('expiresDays').value || null;

      const res = await fetch('/api/admin/generate-key', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ partnerName, customFrom, avatar, expiresDays })
      });

      const data = await res.json();
      if (res.ok) {
        document.getElementById('apiKeyDisplay').textContent = data.key;
        document.getElementById('keyOutput').classList.remove('hidden');
        document.getElementById('partnerName').value = '';
        document.getElementById('customFrom').value = '';
        document.getElementById('avatar').value = '';
        document.getElementById('expiresDays').value = '';

        setStatus(`✅ Key generated.`, false);
        setTimeout(() => document.getElementById('status').classList.add('hidden'), 5000);
        loadKeys();
      } else {
        setStatus('❌ ' + data.error, true);
      }
    }

    function copyKey() {
      const key = document.getElementById('apiKeyDisplay').textContent.replace('Copy', '').trim();
      navigator.clipboard.writeText(key).then(() => {
        const btn = document.querySelector('.copy-btn');
        const original = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = original, 2000);
      });
    }

    async function loadKeys() {
      const res = await fetch('/api/admin/keys', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) return setStatus('Failed to load keys.', true);

      const keys = await res.json();
      const container = document.getElementById('keys');
      container.innerHTML = '';

      keys.forEach(k => {
        const from = k.customFrom || `${k.partnerName}@unfiltereduk.co.uk`;
        const maskedKey = k.key.substring(0, 16) + '...';

        const div = document.createElement('div');
        div.className = 'key-item';
        div.innerHTML = `
          <div><strong>From:</strong> ${from}</div>
          <div><strong>Key:</strong> <span style="font-family:monospace; background:#333; padding:2px 4px; border-radius:4px;">${maskedKey}</span></div>
          <div><strong>Avatar:</strong> ${k.avatar ? `<img src="${k.avatar}" width="20" style="vertical-align:middle; border-radius:50%;">` : 'None'}</div>
          <div><strong>Created:</strong> ${new Date(k.createdAt).toLocaleString()}</div>
          <div><strong>Expires:</strong> ${k.expiresAt ? new Date(k.expiresAt).toLocaleString() : 'Never'}</div>
          <button class="revoke" onclick="revokeKey('${k.key}')">Revoke</button>
        `;
        container.appendChild(div);
      });
    }

    async function revokeKey(key) {
      if (!confirm('Revoke this API key?')) return;

      const res = await fetch('/api/admin/revoke-key', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ key })
      });

      if (res.ok) {
        setStatus('Key revoked.', false);
        loadKeys();
      } else {
        setStatus('Revoke failed.', true);
      }
    }

    function setStatus(msg, error = true) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = error ? 'status error' : 'status success';
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 5000);
    }

    function logout() {
      localStorage.clear();
      location.href = 'index.html';
    }

    window.onload = loadKeys;
  </script>
</body>
</html>
